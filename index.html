<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mey - Expense Tracker (AI Powered)</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. FIGMA EXACT DESIGN TOKENS --- */
        :root {
            /* Backgrounds */
            --bg-main: #FFFDE7;       
            --bg-login: #FFEFCB;      
            --bg-register: #CBE6C0;   
            --bg-scan-dark: #2A3143;  
            --bg-scan-area: #8B9BB4;  
            
            /* Buttons & UI */
            --btn-blue: #CDEDFF;
            --btn-green: #90CD8B;
            --btn-brown: #99836C;
            --btn-confirm: #5A709D;   
            
            /* Texts & Borders */
            --text-main: #131211;
            --text-sub: #68583E;
            --border-solid: 1px solid #131211; 
            
            /* Chart Colors */
            --c-red: #FB8B8B; 
            --c-yellow: #FBD88B; 
            --c-orange: #E0A45C;
            --c-green: #9DD298; 
            --c-blue: #85ACFB; 
            --c-purple: #A25CE0;
            --c-darkblue: #435A88;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; font-family: 'Prompt', sans-serif;
            background-color: #1A202C; height: 100vh;
            display: flex; justify-content: center; align-items: center; color: var(--text-main);
        }

        #app-frame {
            width: 375px; height: 812px; background-color: var(--bg-main);
            border-radius: 40px; box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- 2. ROBUST PAGE SYSTEM --- */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; padding-top: 50px; padding-bottom: 90px;
            overflow-y: auto; background-color: var(--bg-main);
            display: none; flex-direction: column;
            opacity: 0; transform: scale(0.98) translateY(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .page.active { 
            display: flex; opacity: 1; transform: scale(1) translateY(0); z-index: 10;
        }

        .page::-webkit-scrollbar { display: none; }

        .status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 44px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; font-size: 14px; font-weight: 600; color: var(--text-main); z-index: 1000; pointer-events: none;
        }

        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .header h2 { margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center;}
        .back-btn { font-size: 20px; color: var(--c-red); cursor: pointer; border: none; background: none; margin-right: 10px; transition: 0.2s;}
        
        /* --- 3. CLICK ANIMATIONS --- */
        .clickable { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), filter 0.1s; cursor: pointer; }
        .clickable:active { transform: scale(0.94); filter: brightness(0.9); }

        /* --- 4. COMPONENTS --- */
        
        /* Auth Card */
        .auth-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-top: 20px; height: 100%; }
        .auth-tabs { display: flex; border-radius: 10px 10px 0 0; overflow: hidden; margin-top: 20px; border: var(--border-solid); border-bottom: none;}
        .tab { flex: 1; padding: 12px; text-align: center; font-weight: 500; font-size: 14px; transition: background 0.3s;}
        .tab-login { background: var(--bg-login); color: var(--text-main); }
        .tab-register { background: var(--bg-register); color: var(--text-main); border-left: var(--border-solid);}
        .auth-content { padding: 30px 20px; border-radius: 0 0 10px 10px; display: flex; flex-direction: column; border: var(--border-solid); transition: background 0.3s;}
        .auth-label { font-size: 12px; margin-bottom: 5px; font-weight: 500; }
        .auth-input { width: 100%; padding: 12px; border: var(--border-solid); border-radius: 8px; margin-bottom: 15px; font-family: 'Prompt'; outline: none; transition: 0.2s;}
        .auth-input:focus { border-color: var(--btn-confirm); box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2); }

        /* Buttons */
        .btn { padding: 12px 25px; border-radius: 12px; border: var(--border-solid); font-family: 'Prompt'; font-weight: 600; font-size: 14px; text-align: center; display: inline-block;}
        .btn-blue { background: var(--btn-blue); color: var(--text-main); width: 150px; margin: 20px auto 0; }
        .btn-green { background: var(--btn-green); color: var(--text-main); width: 100%; font-size: 16px; padding: 15px;}
        .btn-brown { background: var(--btn-brown); color: white; width: 100%; border: var(--border-solid);} /* เพิ่มขอบให้ปุ่ม Profile */

        /* General Cards & Inputs */
        .card-white { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: var(--border-solid); }
        .input-box { background: white; border: var(--border-solid); border-radius: 8px; padding: 12px; width: 100%; font-family: 'Prompt'; margin-bottom: 15px; outline: none; }

        /* Home Action Buttons */
        .home-actions { display: flex; gap: 10px; margin-bottom: 30px; justify-content: space-between; }
        .action-btn { background: var(--btn-blue); border: var(--border-solid); border-radius: 15px; flex: 1; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: 500; }

        /* Gauge */
        .gauge-wrapper { width: 220px; height: 220px; margin: 0 auto; position: relative; }
        .gauge-ring { width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(var(--bg-register) var(--percent, 42%), #E0E0E0 0); display: flex; justify-content: center; align-items: center; border: var(--border-solid); transition: --percent 1s ease-out; }
        .gauge-inner { width: 170px; height: 170px; background: var(--bg-main); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; border: var(--border-solid); }

        /* History Items */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-radius: 15px; margin-bottom: 10px; font-size: 14px; font-weight: 500; border: var(--border-solid); }
        .item-exp { background: var(--bg-login); }
        .item-inc { background: var(--bg-register); }

        /* --- 5. BOTTOM NAV (The ULTIMATE Fix for Centering) --- */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 75px;
            background: white; border-top: 1px solid #E0E0E0; 
            /* ใช้ CSS Grid บังคับ 3 คอลัมน์กว้างเท่ากันเป๊ะๆ */
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            align-items: center; justify-items: center; /* จับทุกอย่างลงกึ่งกลาง */
            z-index: 100;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9E9E9E; font-size: 10px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%; /* ให้เต็ม grid column */
        }
        .nav-item i { font-size: 22px; margin-bottom: 3px; transition: 0.3s; }
        
        .nav-item.active-nav { color: var(--text-main); font-weight: bold; transform: scale(1.1) translateY(-2px); }
        .nav-item.active-nav i { color: var(--text-main); }
        
        /* ปุ่มตรงกลาง (โฮม หรือ สแกน) */
        .nav-center-wrapper { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            width: 100%; 
            height: 100%; /* FIX: เพิ่มความสูงให้เต็มเพื่อให้จุดอ้างอิงถูกต้อง */
            position: relative;
        }

        /* ปุ่ม Scan (ใหญ่ สีเขียว โผล่ทับเมนู) - เอาคำว่า Scan ออกแล้ว */
        .scan-big-btn {
            width: 65px; height: 65px; background: var(--bg-register); 
            border-radius: 18px; display: flex; justify-content: center; align-items: center;
            border: var(--border-solid); 
            position: absolute; 
            bottom: 12px; /* FIX: ปรับระยะจากขอบล่างให้พอดี */
            left: 50%; /* FIX: ดันมาที่ 50% ของความกว้าง */
            transform: translateX(-50%); /* FIX: ดึงกลับครึ่งหนึ่งของตัวปุ่ม เพื่อให้กลางเป๊ะ */
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: 0.2s;
        }
        .scan-big-btn i { font-size: 28px; color: var(--text-main); margin-bottom: 0;}
        .scan-big-btn:active { transform: translateX(-50%) scale(0.9); background: var(--btn-green); } /* FIX: รักษา translateX ไว้ตอนกด */

        /* Chart */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; padding-top: 20px; border-left: var(--border-solid); border-bottom: var(--border-solid); padding-left: 5px; margin-top: 10px;}
        .bar-group { display: flex; flex-direction: column; align-items: center; width: 12%; height: 100%; justify-content: flex-end; }
        .bar { width: 100%; border: var(--border-solid); border-bottom: none; position: relative; transition: height 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); height: 0; }
        .bar-label { font-size: 10px; margin-top: 5px; color: var(--text-main); font-weight: 500;}

        /* Popups */
        .popup-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); 
            z-index: 2000; display: none; justify-content: center; align-items: center; 
        }
        .popup-box { background: white; width: 85%; padding: 30px 20px; border-radius: 20px; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: var(--border-solid); animation: popUpAnim 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
        .popup-btn-wrap { display: flex; gap: 10px; margin-top: 20px;}
        @keyframes popUpAnim { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Scan Line (Laser) */
        .scan-line {
            width: 100%; height: 2px; background: var(--c-blue); position: absolute; top: 50%; left: 0;
            box-shadow: 0 0 10px white, 0 0 15px var(--c-blue);
            animation: scanMove 2s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes scanMove { 0% { top: 15%; opacity: 0;} 10% {opacity: 1;} 90% {opacity: 1;} 100% { top: 85%; opacity: 0;} }

        /* Chat & Loading Animations */
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #9E9E9E; color: #9E9E9E;
            animation: dotFlashing 1s infinite linear alternate; animation-delay: .5s; margin: 0 10px;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ''; display: inline-block; position: absolute; top: 0;
            width: 6px; height: 6px; border-radius: 5px; background-color: #9E9E9E; color: #9E9E9E;
            animation: dotFlashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dotFlashing { 0% { background-color: #9E9E9E; } 50%, 100% { background-color: #E0E0E0; } }

        .scan-loading-text {
            position: absolute; width: 100%; text-align: center; top: 50%; transform: translateY(-50%);
            color: white; font-size: 16px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: none; z-index: 10;
        }

    </style>
</head>
<body>

    <div id="app-frame">
        <div class="status-bar" id="top-status-bar">
            <span>08:46</span>
            <div><i class="fas fa-signal"></i> <i class="fas fa-wifi"></i> <i class="fas fa-battery-three-quarters"></i></div>
        </div>

        <section id="page-login" class="page active">
            <div class="auth-card">
                <div style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                    <h1 style="font-size: 36px; margin: 0; font-weight: 700;">Logo</h1>
                </div>
                
                <div class="auth-tabs">
                    <div class="tab tab-login clickable" id="tab-login-btn" style="background: var(--bg-login);" onclick="goToAuth('login')">Login</div>
                    <div class="tab tab-register clickable" id="tab-register-btn" style="background: white;" onclick="goToAuth('register')">Register</div>
                </div>
                
                <div class="auth-content" id="auth-box" style="background: var(--bg-login);">
                    <div id="form-login">
                        <div class="auth-label">ชื่อผู้ใช้ (Username/Name):</div>
                        <input type="text" class="auth-input" value="Maleeya">
                        
                        <div class="auth-label">รหัสผ่าน:</div>
                        <div style="position: relative;">
                            <input type="password" class="auth-input" value="123456">
                            <i class="fas fa-eye-slash" style="position: absolute; right: 15px; top: 12px; color: #888;"></i>
                        </div>
                        <div style="text-align: right; font-size: 10px; margin-top: -10px; text-decoration: underline;" class="clickable">ลืมรหัสผ่าน</div>
                        
                        <div style="text-align: center;"><button class="btn btn-blue clickable" onclick="goToPage('page-home')">เข้าสู่ระบบ</button></div>
                    </div>

                    <div id="form-register" style="display: none;">
                        <div class="auth-label">ชื่อผู้ใช้ (Username/Name):</div>
                        <input type="text" class="auth-input">
                        <div class="auth-label">อีเมล (Email):</div>
                        <input type="email" class="auth-input">
                        <div class="auth-label">รหัสผ่าน:</div>
                        <div style="position: relative;">
                            <input type="password" class="auth-input">
                            <i class="fas fa-eye-slash" style="position: absolute; right: 15px; top: 12px; color: #888;"></i>
                        </div>
                        <div class="auth-label">ยืนยันรหัสผ่าน:</div>
                        <input type="password" class="auth-input">
                        <div style="text-align: center;"><button class="btn btn-blue clickable" onclick="goToAuth('login')">ลงทะเบียน</button></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-home" class="page">
            <div class="header" style="margin-top: 10px;">
                <div style="display: flex; align-items: center;">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Maleeya" style="width: 45px; height: 45px; border-radius: 50%; border: var(--border-solid); background: white; margin-right: 15px;">
                    <span style="font-weight: 600; font-size: 18px;">Maleeya</span>
                </div>
                <i class="far fa-bell clickable" style="font-size: 22px;"></i>
            </div>

            <div style="background: white; border: var(--border-solid); border-radius: 15px; padding: 15px; position: relative; margin-bottom: 30px; text-align: center; box-shadow: 4px 4px 0px rgba(0,0,0,0.05);">
                <p id="mey-home-msg" style="margin: 0; font-size: 14px; font-weight: 500;">สวัสดี เราเมย์นะ <br> วันนี้ออมเงินแล้วหรือยัง</p>
                <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width: 80px; position: absolute; right: -10px; bottom: -10px;">
            </div>

            <div class="home-actions">
                <div class="action-btn clickable" onclick="goToPage('page-history')">
                    <i class="far fa-clock" style="font-size: 24px; margin-bottom: 5px;"></i>ประวัติ
                </div>
                <div class="action-btn clickable" onclick="goToPage('page-add')">
                    <i class="fas fa-dollar-sign" style="font-size: 24px; margin-bottom: 5px;"></i>จ่ายเงินสด
                </div>
                <div class="action-btn clickable" onclick="goToPage('page-summary')">
                    <i class="fas fa-chart-simple" style="font-size: 24px; margin-bottom: 5px;"></i>สรุปผล
                </div>
            </div>

            <div class="gauge-wrapper clickable" onclick="goToPage('page-summary')">
                <div class="gauge-ring" id="home-gauge">
                    <div class="gauge-inner">
                        <h1 style="margin: 0; font-size: 32px; font-weight: 700;"><span id="txt-balance">214</span> / 500</h1>
                        <span style="font-size: 20px; font-weight: 600;">บาท</span>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-history" class="page">
            <div class="header">
                <h2><button class="back-btn clickable" onclick="goToPage('page-home')"><i class="fas fa-arrow-left"></i></button> ประวัติ</h2>
                <i class="far fa-bell clickable" style="font-size: 20px;"></i>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 30px; margin-top: 10px; position: relative;">
                <div style="flex: 1; background: var(--bg-register); border-radius: 15px; padding: 15px; text-align: center; border: var(--border-solid);">
                    <div style="font-size: 14px; margin-bottom: 5px; font-weight: 500;">รายรับ</div>
                    <div style="font-weight: 700; font-size: 20px;">500 ฿</div>
                </div>
                
                <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width: 70px; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 2;">
                
                <div style="flex: 1; background: var(--bg-login); border-radius: 15px; padding: 15px; text-align: center; border: var(--border-solid);">
                    <div style="font-size: 14px; margin-bottom: 5px; font-weight: 500;">รายจ่าย</div>
                    <div style="font-weight: 700; font-size: 20px;" id="txt-total-exp">286 ฿</div>
                </div>
            </div>

            <div id="history-list">
                <div class="history-item item-exp clickable"><span><i class="fas fa-train" style="width: 25px;"></i> BTS</span><span>-31</span></div>
                <div class="history-item item-exp clickable"><span><i class="fas fa-coffee" style="width: 25px;"></i> amazon</span><span>-60</span></div>
                <div class="history-item item-exp clickable"><span><i class="fas fa-shopping-cart" style="width: 25px;"></i> 7-Eleven</span><span>-39</span></div>
                <div class="history-item item-inc clickable"><span><i class="fas fa-gift" style="width: 25px;"></i> ได้รับเงินจาก mom</span><span>+500</span></div>
                <div class="history-item item-exp clickable"><span><i class="fas fa-utensils" style="width: 25px;"></i> มื้อกลางวัน</span><span>-45</span></div>
                <div class="history-item item-exp clickable"><span><i class="fas fa-fish" style="width: 25px;"></i> ค่าอาหารสด</span><span>-45</span></div>
            </div>
        </section>

        <section id="page-add" class="page">
            <div class="header">
                <h2><button class="back-btn clickable" onclick="goToPage('page-home')"><i class="fas fa-arrow-left"></i></button> เพิ่มยอดเงินสด</h2>
                <i class="far fa-bell clickable" style="font-size: 20px;"></i>
            </div>
            
            <div style="background: white; border: var(--border-solid); border-radius: 15px; padding: 20px; position: relative; margin-bottom: 30px; box-shadow: 4px 4px 0px rgba(0,0,0,0.05); margin-top: 20px;">
                <p style="margin: 0; font-size: 14px; font-weight: 500;">ใส่จำนวนเงินกับราคาได้เลยนะ</p>
                <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width: 80px; position: absolute; right: -10px; bottom: -10px;">
            </div>

            <div class="card-white" style="padding: 20px;">
                <div class="auth-label">จำนวนเงินที่เพิ่ม</div>
                <input type="number" class="input-box" id="inp-amount" placeholder="0.00">
                
                <div class="auth-label">รายการค่าใช้จ่าย</div>
                <input type="text" class="input-box" id="inp-note">
                
                <button class="btn btn-green clickable" onclick="confirmSave()" style="margin-top: 10px;">เพิ่มยอดเงิน</button>
            </div>
        </section>

        <section id="page-summary" class="page">
            <div class="header">
                <h2><button class="back-btn clickable" onclick="goToPage('page-home')"><i class="fas fa-arrow-left"></i></button> สรุปผล</h2>
                <i class="far fa-bell clickable" style="font-size: 20px;"></i>
            </div>

            <div style="background: var(--btn-blue); border-radius: 15px; padding: 20px; position: relative; margin-bottom: 20px; text-align: center; border: var(--border-solid);">
                <div style="font-size: 18px; font-weight: 600;">ยอดเงินเหลือรวม</div>
                <div style="font-size: 28px; font-weight: 700;"><span id="txt-summary-bal">230</span> บาท</div>
                <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width: 90px; position: absolute; right: -5px; bottom: -15px;">
            </div>

            <div style="background: var(--btn-blue); border-radius: 15px; padding: 20px; border: var(--border-solid); padding-bottom: 10px;">
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 15px;">สรุปค่าใช้จ่าย</div>
                <select class="input-box" style="margin-bottom: 20px; border-radius: 10px; font-family: 'Prompt'; padding: 8px;"><option>รายสัปดาห์</option></select>
                <div class="chart-container" id="chart-area"></div>
            </div>
            
             <div style="background: var(--c-darkblue); border-radius: 15px 15px 0 0; padding: 20px; margin-top: 20px; text-align: center; color: white; border: var(--border-solid);">
                 <p style="margin-top: 0;">ค่าใช้จ่ายสัปดาห์นี้</p>
                 <div style="width: 100%; height: 20px; background: linear-gradient(90deg, var(--c-blue) 20%, var(--c-green) 20% 60%, var(--c-orange) 60% 85%, var(--c-red) 85%); border-radius: 10px; border: var(--border-solid);"></div>
                 <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 5px;">
                     <span>เงินเก็บ</span><span>จำเป็น</span><span>ไม่จำเป็น</span><span>ฟุ่มเฟือย</span>
                 </div>
             </div>
        </section>

        <section id="page-profile" class="page">
            <div class="header">
                 <h2><button class="back-btn clickable" onclick="goToPage('page-home')"><i class="fas fa-arrow-left"></i></button> Profile</h2>
            </div>

            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--text-sub);">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Maleeya" style="width: 70px; height: 70px; border-radius: 15px; border: var(--border-solid); background: white;">
                <div style="flex: 1;">
                    <div style="font-size: 12px; font-weight: 500;">ชื่อ-นามสกุล</div>
                    <input type="text" value="Maleeya Samaru" class="input-box" style="margin-bottom: 0; padding: 8px 12px;">
                </div>
            </div>

            <div class="auth-label">อาชีพ</div>
            <input type="text" class="input-box" value="Student">
            <div class="auth-label">วันเดือนปีเกิด</div>
            <input type="text" class="input-box" value="01/01/2000">
            <div class="auth-label">เบอร์โทรศัพท์</div>
            <input type="text" class="input-box" value="088-888-8888">
            <div class="auth-label">อีเมล</div>
            <input type="text" class="input-box" value="maleeya@mail.com">
            
            <div style="text-align: center; margin-top: 10px;">
                <button class="btn btn-brown clickable" style="margin-bottom: 20px;" onclick="saveProfile()">บันทึกข้อมูล</button> <br>
                <button class="btn btn-brown clickable" onclick="goToPage('page-login')">ออกจากระบบ</button>
            </div>
        </section>

        <section id="page-chat" class="page">
             <div class="header" style="border-bottom: 1px solid #EEE; padding-bottom: 10px;">
                <h2><button class="back-btn clickable" onclick="goToPage('page-home')"><i class="fas fa-arrow-left"></i></button> แชทกับเมย์</h2>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 10px 0;" id="chat-history">
                <div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 30px; height: 30px; background: var(--text-main); border-radius: 50%;"></div>
                    <div>
                        <span style="font-size: 12px; font-weight: 600;">May</span>
                        <div style="background: #E0E0E0; padding: 15px; border-radius: 0 15px 15px 15px; font-size: 14px; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; color: var(--text-sub); border: var(--border-solid);">
                            May ได้ส่งรูปภาพ
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 30px; height: 30px; background: var(--text-main); border-radius: 50%;"></div>
                    <div>
                        <span style="font-size: 12px; font-weight: 600;">May</span>
                        <div style="background: #E0E0E0; padding: 10px 15px; border-radius: 0 15px 15px 15px; font-size: 14px; border: var(--border-solid);">
                            เธอเพิ่งซื้อทิฟไปเมื่อ 3 วันที่แล้วเอง
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="background: white; padding: 10px 0; display: flex; gap: 10px; align-items: center;">
                <i class="fas fa-bars clickable" style="color: #9E9E9E; font-size: 20px;"></i>
                <input type="text" id="chat-input" style="flex: 1; padding: 10px 15px; border-radius: 20px; border: var(--border-solid); background: #D9EAFF; font-family: 'Prompt'; outline: none;">
                <button style="border: none; background: none;" class="clickable" onclick="sendMessage()">
                    <i class="fas fa-paper-plane" style="color: var(--c-blue); font-size: 20px;"></i>
                </button>
            </div>
        </section>

        <section id="page-scan" class="page" style="background: var(--bg-scan-dark); padding-top: 50px;">
             <div class="header">
                 <h2><button class="back-btn clickable" onclick="goToPage('page-home')" style="color: white;"><i class="fas fa-arrow-left"></i></button> <span style="color: white;">Scan</span></h2>
                 <i class="far fa-bell clickable" style="font-size: 20px; color: white;"></i>
            </div>
             
             <!-- ✨ Gemini Feature: Receipt Scanner with Hidden Input -->
             <div style="background: var(--bg-scan-area); height: 500px; width: 100%; border: 4px solid var(--c-blue); position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-top: 20px; border-radius: 5px;">
                 
                 <!-- Corner Markers -->
                 <div style="position: absolute; top: 40px; left: 40px; width: 30px; height: 30px; border-top: 4px solid var(--text-main); border-left: 4px solid var(--text-main);"></div>
                 <div style="position: absolute; top: 40px; right: 40px; width: 30px; height: 30px; border-top: 4px solid var(--text-main); border-right: 4px solid var(--text-main);"></div>
                 <div style="position: absolute; bottom: 40px; left: 40px; width: 30px; height: 30px; border-bottom: 4px solid var(--text-main); border-left: 4px solid var(--text-main);"></div>
                 <div style="position: absolute; bottom: 40px; right: 40px; width: 30px; height: 30px; border-bottom: 4px solid var(--text-main); border-right: 4px solid var(--text-main);"></div>
                 
                 <!-- Hidden File Input for Gemini Vision -->
                 <input type="file" id="receipt-upload" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
                 
                 <!-- Clickable Trigger -->
                 <div class="clickable" onclick="document.getElementById('receipt-upload').click()" style="position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 8px; display: flex; z-index: 20;">
                     <i class="fas fa-image" style="font-size: 20px; color: white;"></i>
                 </div>

                 <!-- Loading Text -->
                 <div id="scan-loading" class="scan-loading-text">
                     <i class="fas fa-spinner fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i><br>
                     กำลังวิเคราะห์ใบเสร็จด้วย ✨Gemini...
                 </div>

                 <div class="scan-line" id="laser-line"></div>
             </div>
             
             <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width: 90px; position: absolute; bottom: 100px; right: 0;">
        </section>

        <div id="popup-success" class="popup-overlay">
            <div class="popup-box">
                <i class="fas fa-check-circle" style="font-size: 50px; margin-bottom: 10px; color: var(--btn-green);"></i>
                <h3 style="margin: 0; font-size: 18px;">บันทึกข้อมูลสำเร็จ</h3>
                <div class="popup-btn-wrap" style="justify-content: center;">
                    <button class="btn btn-green clickable" style="width: 100%; color: var(--text-main);" onclick="closePopup('popup-success'); goToPage('page-home');">ตกลง</button>
                </div>
            </div>
        </div>

        <div id="popup-confirm" class="popup-overlay">
            <div class="popup-box" style="border: 2px dashed #A25CE0;">
                <div style="background: #E8F5E9; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: var(--border-solid);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 30px; color: var(--text-main);"></i>
                </div>
                <h3 style="margin: 0; font-size: 18px;">ยืนยันการบันทึกข้อมูล</h3>
                <p style="font-size: 12px; color: #888; margin-bottom: 20px;">ตรวจสอบข้อมูลให้ถูกต้องก่อนยืนยัน</p>
                
                <div class="popup-btn-wrap">
                    <button class="btn clickable" style="flex: 1; border: var(--border-solid); background: white;" onclick="closePopup('popup-confirm')">Cancel</button>
                    <button class="btn clickable" style="flex: 1; background: var(--btn-confirm); color: white;" onclick="finalizeAdd()">Confirm</button>
                </div>
            </div>
        </div>

        <div id="popup-scan" class="popup-overlay">
            <div style="background: #7988A2; width: 80%; padding: 20px; border-radius: 10px; text-align: center; color: white; border: var(--border-solid); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <p style="margin: 0; font-size: 14px;">ไม่พบราคาในรูป</p>
                <input type="number" class="input-box" id="scan-price" placeholder="กรุณาระบุราคา" style="border-radius: 5px; text-align: center; margin-bottom: 15px; border:none;">
                <button class="btn clickable" style="background: var(--btn-confirm); color: white; width: 100%; border: var(--border-solid);" onclick="finishScan()">Confirm</button>
            </div>
        </div>

        <div class="bottom-nav" id="main-nav">
            
            <div class="nav-item clickable" id="nav-profile" onclick="goToPage('page-profile')">
                <i class="far fa-user"></i> <span>Profile</span>
            </div>
            
            <div class="nav-center-wrapper clickable" onclick="handleCenterClick()">
                <div class="nav-item" id="center-icon-home">
                    <i class="fas fa-home"></i> <span>Home</span>
                </div>
                
                <div id="center-icon-scan" style="display: none;">
                    <div class="scan-big-btn">
                        <i class="fas fa-expand"></i>
                    </div>
                </div>
            </div>
            
            <div class="nav-item clickable" id="nav-chat" onclick="goToPage('page-chat')">
                <i class="far fa-comment-dots"></i> <span>May</span>
            </div>
            
        </div>
    </div>

    <script>
        // --- ✨ Gemini API Config ---
        const apiKey = ""; // API Key injected by environment
        const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let state = { budget: 500, expense: 286, balance: 214, chartData: [369, 335, 301, 341, 324, 350, 214] };

        // --- Clock ---
        setInterval(() => {
            const now = new Date();
            document.querySelectorAll('.status-bar span').forEach(el => el.innerText = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }));
        }, 1000);

        // --- Tabs Logic ---
        function goToAuth(type) {
            if(type === 'login') {
                document.querySelector('.tab-login').style.backgroundColor = 'var(--bg-login)';
                document.querySelector('.tab-register').style.backgroundColor = 'white';
                document.getElementById('auth-box').style.background = 'var(--bg-login)';
                document.getElementById('form-login').style.display = 'block'; 
                document.getElementById('form-register').style.display = 'none';
            } else {
                document.querySelector('.tab-login').style.backgroundColor = 'white';
                document.querySelector('.tab-register').style.backgroundColor = 'var(--bg-register)';
                document.getElementById('auth-box').style.background = 'var(--bg-register)';
                document.getElementById('form-login').style.display = 'none'; 
                document.getElementById('form-register').style.display = 'block';
            }
        }

        // --- Core Navigation ---
        let currentPage = '';
        
        function handleCenterClick() {
            if (currentPage === 'page-home') {
                startScan(); 
            } else {
                goToPage('page-home'); 
            }
        }

        function goToPage(pageId) {
            if (currentPage === pageId) return; 
            currentPage = pageId;
            
            // 1. ซ่อนทุกหน้า
            const pages = document.querySelectorAll('.page');
            pages.forEach(p => { 
                p.style.display = 'none'; 
                p.classList.remove('active'); 
            });
            
            // 2. แสดงหน้าเป้าหมาย
            const target = document.getElementById(pageId);
            if (target) {
                target.style.display = 'flex'; 
                void target.offsetWidth; // บังคับ UI อัพเดทก่อนใส่ Animation
                target.classList.add('active'); 
            }

            const nav = document.getElementById('main-nav');
            const statusBar = document.getElementById('top-status-bar');

            // ซ่อน Nav เฉพาะบางหน้า
            if(pageId === 'page-scan' || pageId === 'page-login') {
                statusBar.style.color = pageId === 'page-scan' ? "white" : "var(--text-main)";
                nav.style.transform = "translateY(100%)";
            } else {
                statusBar.style.color = "var(--text-main)";
                nav.style.transform = "translateY(0)";
                updateNavState(pageId);
            }

            if(pageId === 'page-home') updateHomeUI();
            if(pageId === 'page-history') document.getElementById('txt-total-exp').innerText = state.expense.toLocaleString() + ' ฿';
            if(pageId === 'page-summary') renderChart();
            if(pageId === 'page-chat') setTimeout(() => { const b = document.getElementById('chat-history'); if(b) b.scrollTop = b.scrollHeight; }, 100);
        }

        function updateNavState(pageId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
            document.getElementById('center-icon-home').classList.remove('active-nav');
            
            const iconHome = document.getElementById('center-icon-home');
            const iconScan = document.getElementById('center-icon-scan');

            if(pageId === 'page-home') {
                iconHome.style.display = 'none';
                iconScan.style.display = 'flex'; 
            } else {
                iconHome.style.display = 'flex'; 
                iconScan.style.display = 'none';
                
                if(['page-history', 'page-add', 'page-summary'].includes(pageId)) iconHome.classList.add('active-nav');
                if(pageId === 'page-profile') document.getElementById('nav-profile').classList.add('active-nav');
                if(pageId === 'page-chat') document.getElementById('nav-chat').classList.add('active-nav');
            }
        }

        // --- UI & Charts ---
        function updateHomeUI() {
            document.getElementById('txt-balance').innerText = state.balance.toLocaleString();
            document.getElementById('txt-summary-bal').innerText = state.balance.toLocaleString();
            let percent = (state.balance / state.budget) * 100;
            document.getElementById('home-gauge').style.background = `conic-gradient(var(--bg-register) ${Math.max(0,Math.min(percent,100))}%, #E0E0E0 0)`;
        }

        function renderChart() {
            const container = document.getElementById('chart-area'); container.innerHTML = ''; 
            const days = ['อา.', 'จ.', 'อ.', 'พ.', 'พฤ.', 'ศ.', 'ส.'];
            const colors = ['var(--c-red)', 'var(--c-yellow)', 'var(--c-orange)', 'var(--c-green)', 'var(--c-orange)', 'var(--c-blue)', 'var(--c-purple)'];
            const maxVal = Math.max(...state.chartData, 500);

            state.chartData.forEach((val, index) => {
                const heightPercent = (val / maxVal) * 80; 
                const group = document.createElement('div'); group.className = 'bar-group';
                group.innerHTML = `<div class="bar" style="background: ${colors[index]}; border: var(--border-solid); border-bottom: none;"></div><div class="bar-label">${days[index]}</div>`;
                container.appendChild(group);
                setTimeout(() => { group.querySelector('.bar').style.height = heightPercent + '%'; }, 100 * index + 100); 
            });
        }

        // --- Popups ---
        function showPopup(id) { const el = document.getElementById(id); el.style.display = 'flex'; }
        function closePopup(id) { document.getElementById(id).style.display = 'none'; }

        // --- Actions ---
        function saveProfile() { showPopup('popup-success'); }
        function confirmSave() {
            const amt = document.getElementById('inp-amount').value;
            if(!amt) return alert('กรุณาใส่จำนวนเงิน');
            window.tempTx = { amount: parseInt(amt), name: document.getElementById('inp-note').value || 'รายจ่ายทั่วไป' };
            showPopup('popup-confirm');
        }
        function finalizeAdd() {
            const tx = window.tempTx; state.balance -= tx.amount; state.expense += tx.amount; state.chartData[6] += tx.amount; 
            document.getElementById('history-list').insertAdjacentHTML('afterbegin', `<div class="history-item item-exp clickable"><span><i class="fas fa-shopping-cart" style="width: 25px;"></i> ${tx.name}</span><span>-${tx.amount}</span></div>`);
            closePopup('popup-confirm'); document.getElementById('inp-amount').value = ''; document.getElementById('inp-note').value = '';
            goToPage('page-home');
        }

        function startScan() {
            const scanBtn = document.querySelector('.scan-big-btn');
            scanBtn.style.transform = "scale(0.9)"; 
            setTimeout(() => {
                scanBtn.style.transform = "scale(1)";
                goToPage('page-scan');
                // No automatic popup. Wait for user to click photo icon to upload.
            }, 100);
        }
        function finishScan() {
            const price = document.getElementById('scan-price').value;
            if(price) { document.getElementById('inp-amount').value = price; closePopup('popup-scan'); goToPage('page-add'); }
        }

        // --- ✨ Gemini Helper Function ---
        async function callGemini(promptText, imageBase64 = null, isJson = false) {
            let parts = [{ text: promptText }];
            if (imageBase64) {
                // Ensure image data is clean (remove data:image/png;base64, prefix if present for API)
                const base64Data = imageBase64.split(',')[1] || imageBase64;
                parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
            }

            const payload = {
                contents: [{ parts: parts }]
            };
            
            if(isJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return null;
            }
        }

        // --- ✨ Chat with May (Gemini Powered) ---
        async function sendMessage() {
            const inp = document.getElementById('chat-input'); 
            const msg = inp.value; 
            if(!msg) return;
            
            const box = document.getElementById('chat-history');
            
            // Add User Message
            box.insertAdjacentHTML('beforeend', `<div style="margin-bottom: 15px; text-align: right;"><div style="background: var(--bg-register); padding: 10px 15px; border-radius: 15px 15px 0 15px; display: inline-block; max-width: 80%; font-size: 14px; border: var(--border-solid); text-align: left;">${msg}</div></div>`);
            inp.value = ''; 
            box.scrollTop = box.scrollHeight;
            
            // Add Loading Bubble
            const loadingId = 'loading-' + Date.now();
            box.insertAdjacentHTML('beforeend', `
                <div id="${loadingId}" style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 30px; height: 30px; background: var(--c-darkblue); border-radius: 50%; border: var(--border-solid);"></div>
                    <div>
                        <span style="font-size: 12px; font-weight: 600;">May</span>
                        <div style="background: #E0E0E0; padding: 10px 15px; border-radius: 0 15px 15px 15px; font-size: 14px; border: var(--border-solid); display:flex; align-items:center; height: 36px;">
                            <div class="dot-flashing"></div>
                        </div>
                    </div>
                </div>`);
            box.scrollTop = box.scrollHeight;

            // Construct System Prompt with Context
            const systemPrompt = `
                You are May, a helpful, thrifty, and cute financial assistant for an expense tracker app.
                Current User Balance: ${state.balance} Baht.
                Total Expenses: ${state.expense} Baht.
                
                Reply in Thai. Keep it short (1-2 sentences). Be encouraging about saving money.
                If the user asks about their balance, tell them exactly from the context.
                User says: "${msg}"
            `;

            // Call Gemini
            const reply = await callGemini(systemPrompt);
            
            // Remove Loading
            document.getElementById(loadingId).remove();

            // Add AI Reply
            const finalReply = reply || "ขอโทษค่ะ เมย์มึนหัวนิดหน่อย ลองถามใหม่นะ";
            box.insertAdjacentHTML('beforeend', `<div style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px;"><div style="width: 30px; height: 30px; background: var(--c-darkblue); border-radius: 50%; border: var(--border-solid);"></div><div><span style="font-size: 12px; font-weight: 600;">May</span><div style="background: #E0E0E0; padding: 10px 15px; border-radius: 0 15px 15px 15px; font-size: 14px; border: var(--border-solid);">${finalReply}</div></div></div>`);
            box.scrollTop = box.scrollHeight;
        }
        document.getElementById('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });


        // --- ✨ Gemini Vision: Receipt Scanner ---
        async function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                // Show Loading State
                document.getElementById('scan-loading').style.display = 'block';
                document.getElementById('laser-line').style.display = 'none';

                reader.onload = async function(e) {
                    const base64Image = e.target.result;
                    
                    // Gemini Prompt for JSON extraction
                    const prompt = "Analyze this receipt image. Extract the Merchant Name and the Total Amount. Return ONLY a JSON object with keys: 'merchant' (string) and 'amount' (number). If you cannot find them, return null.";
                    
                    try {
                        const jsonString = await callGemini(prompt, base64Image, true); // true for JSON mode
                        const data = JSON.parse(jsonString);

                        if (data && data.amount) {
                            // Populate Add Form
                            document.getElementById('inp-amount').value = data.amount;
                            document.getElementById('inp-note').value = data.merchant || "ค่าใช้จ่ายทั่วไป";
                            
                            // Reset UI & Navigate
                            document.getElementById('scan-loading').style.display = 'none';
                            document.getElementById('laser-line').style.display = 'block';
                            input.value = ''; // Reset input
                            goToPage('page-add');
                        } else {
                            throw new Error("No data found");
                        }
                    } catch (err) {
                        console.error("Scan Error", err);
                        document.getElementById('scan-loading').style.display = 'none';
                        document.getElementById('laser-line').style.display = 'block';
                        showPopup('popup-scan'); // Fallback to manual entry
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // เริ่มต้นแอปให้รันหน้า Login ก่อนเสมอ
        window.onload = () => {
            goToPage('page-login');
        };
    </script>
</body>
</html>